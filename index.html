<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Particles Camera v4 â€“ Privacy View</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000}
#camView{
 position:fixed;right:12px;bottom:12px;
 width:180px;height:240px;
 border-radius:14px;overflow:hidden;
 box-shadow:0 12px 40px rgba(0,0,0,.7);
 z-index:10
}
#camView video{
 width:100%;height:100%;object-fit:cover;
 transform:scaleX(-1)
}
#start{
 position:fixed;bottom:20px;left:50%;
 transform:translateX(-50%);
 padding:14px 26px;font-size:16px;
 border:none;border-radius:14px;
 background:#00e5ff;color:#000;z-index:11
}
video.main{display:none}
</style>
</head>
<body>

<button id="start">Enable Camera</button>

<div id="camView" style="display:none">
 <video id="preview" autoplay playsinline muted></video>
</div>

<video id="video" class="main" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* DEVICE */
const isMobile=/Android|iPhone|iPad/i.test(navigator.userAgent);
const COUNT=isMobile?7000:14000;

/* THREE */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x000000,50,180);
const cam3D=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,600);
cam3D.position.z=95;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(2,devicePixelRatio));
document.body.appendChild(renderer.domElement);

addEventListener('resize',()=>{
 cam3D.aspect=innerWidth/innerHeight;
 cam3D.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});

/* PARTICLES */
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
const tgt=new Float32Array(COUNT*3);
const col=new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
 const c=new THREE.Color(0x00e5ff);
 col[i*3]=c.r;col[i*3+1]=c.g;col[i*3+2]=c.b;
}
geo.setAttribute("position",new THREE.BufferAttribute(pos,3));
geo.setAttribute("color",new THREE.BufferAttribute(col,3));

const mat=new THREE.PointsMaterial({
 size:isMobile?.16:.12,
 vertexColors:true,
 transparent:true,
 opacity:.9,
 depthWrite:false
});
const pts=new THREE.Points(geo,mat);
scene.add(pts);

/* CAR WIREFRAME SHAPE */
function carWireframe(){
 for(let i=0;i<COUNT;i++){
  let x=(Math.random()-0.5)*60;
  let y=(Math.random()-0.5)*20;
  let z=(Math.random()-0.5)*25;
  if(Math.abs(x)>25&&Math.abs(y)<6) y*=0.3;
  tgt[i*3]=x;
  tgt[i*3+1]=y;
  tgt[i*3+2]=z;
 }
}
carWireframe();

/* HAND TRACKING */
let hx=0,hy=0,shx=0,shy=0;
const hands=new Hands({
 locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
 maxNumHands:1,modelComplexity:1,
 minDetectionConfidence:.7,
 minTrackingConfidence:.7
});
hands.onResults(r=>{
 if(!r.multiHandLandmarks.length)return;
 const lm=r.multiHandLandmarks[0];
 const i=lm[8];
 shx=(i.x-.5)*120;
 shy=-(i.y-.5)*80;
 hx+= (shx-hx)*.2;
 hy+= (shy-hy)*.2;
});

/* CAMERA */
const video=document.getElementById("video");
const pv=document.getElementById("preview");
const btn=document.getElementById("start");

btn.onclick=async()=>{
 try{
  const stream=await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject=stream;
  pv.srcObject=stream;
  document.getElementById("camView").style.display="block";
  const cam=new Camera(video,{onFrame:async()=>hands.send({image:video})});
  cam.start();
  btn.remove();
 }catch(e){alert("Camera permission denied");}
};

/* LOOP */
function animate(){
 requestAnimationFrame(animate);
 for(let i=0;i<COUNT;i++){
  pos[i*3]+= (tgt[i*3]+hx-pos[i*3])*.04;
  pos[i*3+1]+= (tgt[i*3+1]+hy-pos[i*3+1])*.04;
  pos[i*3+2]+= (tgt[i*3+2]-pos[i*3+2])*.04;
 }
 geo.attributes.position.needsUpdate=true;
 pts.rotation.y+=.001;
 renderer.render(scene,cam3D);
}
animate();
</script>
</body>
</html>
