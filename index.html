<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Particles Camera v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:black;
  font-family:monospace;
}
#ui{
  position:fixed;
  top:10px;
  left:10px;
  color:#00ffff;
  font-size:13px;
  z-index:10;
}
#start{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  padding:14px 24px;
  font-size:16px;
  border:none;
  border-radius:10px;
  background:#00ffff;
  color:#000;
  cursor:pointer;
  z-index:10;
}
video{ display:none; }
</style>
</head>

<body>

<div id="ui">
Camera + Hand Control<br>
Move hand → Attract<br>
Pinch → Change shape
</div>

<button id="start">Enable Camera</button>
<video id="video" autoplay playsinline></video>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ======================
   DEVICE ADAPT
====================== */
const isMobile=/Android|iPhone|iPad/i.test(navigator.userAgent);
const COUNT=isMobile?6000:12000;

/* ======================
   THREE SETUP
====================== */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x000000,40,140);

const camera3D=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,500);
camera3D.position.z=80;

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(2,devicePixelRatio));
document.body.appendChild(renderer.domElement);

window.addEventListener('resize',()=>{
  camera3D.aspect=innerWidth/innerHeight;
  camera3D.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

/* ======================
   PARTICLES
====================== */
const geo=new THREE.BufferGeometry();
const pos=new Float32Array(COUNT*3);
const tgt=new Float32Array(COUNT*3);
const col=new Float32Array(COUNT*3);

for(let i=0;i<COUNT;i++){
  const c=new THREE.Color().setHSL(Math.random(),1,0.6);
  col[i*3]=c.r; col[i*3+1]=c.g; col[i*3+2]=c.b;
}

geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
geo.setAttribute('color',new THREE.BufferAttribute(col,3));

const mat=new THREE.PointsMaterial({
  size:isMobile?0.18:0.14,
  vertexColors:true,
  transparent:true,
  depthWrite:false
});

const points=new THREE.Points(geo,mat);
scene.add(points);

/* ======================
   SHAPES
====================== */
const shapes=[galaxy,heart,flower,sphere,saturn];
let si=0;

function galaxy(){
  for(let i=0;i<COUNT;i++){
    let r=Math.random()*40,a=Math.random()*Math.PI*2;
    tgt[i*3]=Math.cos(a)*r;
    tgt[i*3+1]=(Math.random()-0.5)*8;
    tgt[i*3+2]=Math.sin(a)*r;
  }
}
function heart(){
  for(let i=0;i<COUNT;i++){
    let t=Math.random()*Math.PI*2;
    tgt[i*3]=16*Math.pow(Math.sin(t),3);
    tgt[i*3+1]=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    tgt[i*3+2]=(Math.random()-0.5)*8;
  }
}
function flower(){
  for(let i=0;i<COUNT;i++){
    let t=Math.random()*Math.PI*2;
    let r=22*Math.sin(6*t);
    tgt[i*3]=Math.cos(t)*r;
    tgt[i*3+1]=Math.sin(t)*r;
    tgt[i*3+2]=(Math.random()-0.5)*6;
  }
}
function sphere(){
  for(let i=0;i<COUNT;i++){
    let u=Math.random(),v=Math.random();
    let th=2*Math.PI*u,ph=Math.acos(2*v-1);
    let r=30;
    tgt[i*3]=r*Math.sin(ph)*Math.cos(th);
    tgt[i*3+1]=r*Math.sin(ph)*Math.sin(th);
    tgt[i*3+2]=r*Math.cos(ph);
  }
}
function saturn(){
  for(let i=0;i<COUNT;i++){
    let a=Math.random()*Math.PI*2;
    let r=28+Math.random()*10;
    tgt[i*3]=Math.cos(a)*r;
    tgt[i*3+1]=(Math.random()-0.5)*3;
    tgt[i*3+2]=Math.sin(a)*r;
  }
}
shapes[0]();

/* ======================
   HAND TRACKING
====================== */
let hx=0,hy=0,pinch=false,lock=false;

const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

hands.onResults(r=>{
  if(!r.multiHandLandmarks.length) return;
  const lm=r.multiHandLandmarks[0];
  const i=lm[8],t=lm[4];

  hx=(i.x-0.5)*80;
  hy=-(i.y-0.5)*50;

  const d=Math.hypot(i.x-t.x,i.y-t.y);
  pinch=d<0.03;

  if(pinch&&!lock){
    si=(si+1)%shapes.length;
    shapes[si]();
    lock=true;
    setTimeout(()=>lock=false,600);
  }
});

/* ======================
   CAMERA BUTTON
====================== */
const video=document.getElementById("video");
document.getElementById("start").onclick=async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject=stream;

    const cam=new Camera(video,{
      onFrame:async()=>await hands.send({image:video}),
      width:640,height:480
    });
    cam.start();
    document.getElementById("start").remove();
  }catch(e){
    alert("Camera permission denied");
  }
};

/* ======================
   LOOP
====================== */
function animate(){
  requestAnimationFrame(animate);
  for(let i=0;i<COUNT;i++){
    pos[i*3]+= (tgt[i*3]+hx-pos[i*3])*0.05;
    pos[i*3+1]+= (tgt[i*3+1]+hy-pos[i*3+1])*0.05;
    pos[i*3+2]+= (tgt[i*3+2]-pos[i*3+2])*0.05;
  }
  geo.attributes.position.needsUpdate=true;
  points.rotation.y+=0.0012;
  renderer.render(scene,camera3D);
}
animate();
</script>

</body>
</html>
